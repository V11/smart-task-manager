var STM=STM||{};STM.TaskStatuses={OPENED:"Opened",PENDING:"Pending",CLOSED:"Closed"},STM.TaskPriorities={LOW:"Low",MEDIUM:"Medium",HIGH:"High"},STM.TaskActions={CREATE:"create",EDIT:"edit"},STM.Events={TOGGLE:"toggle",ARCHIVED:"archived",PROCEED_REMOVING:"proceed-removing"};var Task=Backbone.Model.extend({defaults:function(){return{title:"",content:"",priority:STM.TaskPriorities.MEDIUM,status:STM.TaskStatuses.OPENED,createdAt:new Date,deadline:0}},start:function(){this.save({status:STM.TaskStatuses.PENDING})},complete:function(){this.save({status:STM.TaskStatuses.CLOSED}),this.trigger(STM.Events.ARCHIVED)},reopen:function(){this.save({status:STM.TaskStatuses.OPENED})},toggle:function(e){this.trigger(STM.Events.TOGGLE,e)}}),TaskList=Backbone.Collection.extend({model:Task,localStorage:new Backbone.LocalStorage("stm")}),STM=STM||{};STM.utils={formatDate:function(e){return e.getFullYear()+"-"+this.formatNumber(e.getMonth())+"-"+this.formatNumber(e.getDate())+" "+this.formatNumber(e.getHours())+":"+this.formatNumber(e.getMinutes())},formatNumber:function(e){return 10>e?"0"+e:e.toString()}};var TaskView=Backbone.View.extend({tagName:"tr",className:"task",template:_.template($("#task-template").html()),contentTemplate:_.template($("#content-template").html()),timeoutToDelete:null,showArchived:!1,TIMEOUT_TO_DELETE:1e4,events:{"click .start":"start","click .complete":"complete","click .reopen":"reopen","click .remove":"addProceedListener","click .undo":"cancelDeleting","click .edit":"edit","click .toggle":"showContent"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,STM.Events.ARCHIVED,this.archive),this.listenTo(this.model,STM.Events.TOGGLE,this.toggle),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=this.model.toJSON();return e.createdAt=STM.utils.formatDate(new Date(e.createdAt)),this.$el.html(this.template(e)),this.clearStateClasses(),this.$el.addClass(this.getStateClassName()),this.$el.next().hasClass("task-content")&&this.$el.next().remove(),this.model.get("status")!==STM.TaskStatuses.CLOSED||this.showArchived||this.$el.hide(),this},clearStateClasses:function(){this.$el.removeClass("active warning success")},getStateClassName:function(){var e="active";switch(this.model.get("status")){case STM.TaskStatuses.PENDING:e="warning";break;case STM.TaskStatuses.CLOSED:e="success"}return e},archive:function(){this.showArchived||this.$el.hide()},toggle:function(e){this.showArchived=e,this.model.get("status")===STM.TaskStatuses.CLOSED&&this.$el.toggle(e)},start:function(){this.model.start()},complete:function(){this.model.complete()},reopen:function(){this.model.reopen()},edit:function(){var e=_.extend(this.model.toJSON(),{cid:this.model.cid}),t="";for(var s in e)t="#task-data *[name="+s+"]",$(t).val(e[s]);$(".selectpicker").selectpicker("val",e.priority)},showContent:function(){if(this.$el.next().hasClass("task-content"))this.$el.next().remove();else{var e=this.contentTemplate({content:this.model.get("content")});this.$el.after(e)}},addProceedListener:function(){STM.eventDispatcher.on(STM.Events.PROCEED_REMOVING,this.aboutToDelete.bind(this))},aboutToDelete:function(){STM.eventDispatcher.off(STM.Events.PROCEED_REMOVING),this.$el.addClass("about-to-delete"),this.timeoutToDelete=setTimeout(this.destroy.bind(this),this.TIMEOUT_TO_DELETE)},cancelDeleting:function(){clearTimeout(this.timeoutToDelete),this.$el.removeClass("about-to-delete")},destroy:function(){this.model.destroy()}}),TaskListView=Backbone.View.extend({el:$("#stm"),model:TaskList,events:{"change #archived-tasks":"toggleCompleted","submit #task-data":"processTask","show.bs.modal #task":"onTaskDialogOpened","hidden.bs.modal #remove-task":"onRemoveDialogClosed","click #proceed-removing":"proceedRemoving"},initialize:function(){this.initView(),this.listenTo(this.model,"add",this.addOne),this.model.fetch()},initView:function(){$("#datetimepicker").datetimepicker({format:"yyyy-mm-dd hh:ii",todayHighlight:!0,autoclose:!0});var e=function(){$(this).parent().removeClass("has-error")};$("input[name=title]").focus(e),$("textarea[name=content]").focus(e)},addOne:function(e){var t=new TaskView({model:e});this.$("#task-list").append(t.render().el),e.save()},processTask:function(e){e.preventDefault();var t=$(e.currentTarget).serializeArray(),s={},i=null;return t.forEach(function(e){s[e.name]=e.value}),this.validateForm(s.title,s.content)?(""!==s.cid?(i=this.model.get({cid:s.cid}),i.save(s)):(i=new Task(s),this.model.add(i)),this.resetForm(),$("#task").modal("hide"),!1):!1},validateForm:function(e,t){var s=$("input[name=title]").parent(),i=$("textarea[name=content]").parent(),a=!0;return""===e?(s.addClass("has-error"),a=!1):s.removeClass("has-error"),""===t?(i.addClass("has-error"),a=!1):i.removeClass("has-error"),a},onTaskDialogOpened:function(e){var t="#task .modal-title",s=$(e.relatedTarget).data("action");s===STM.TaskActions.CREATE?($(t).text("New task"),this.resetForm()):$(t).text("Edit task")},resetForm:function(){$("#task-data")[0].reset(),$("#task-data input[name=cid]").val("")},toggleCompleted:function(e){this.model.forEach(function(t){t.toggle(e.currentTarget.checked)})},proceedRemoving:function(){$("#remove-task").modal("hide"),STM.eventDispatcher.trigger(STM.Events.PROCEED_REMOVING)},onRemoveDialogClosed:function(){STM.eventDispatcher.off(STM.Events.PROCEED_REMOVING)}}),STM=STM||{};STM.eventDispatcher={},_.extend(STM.eventDispatcher,Backbone.Events),STM.init=function(){new TaskListView({model:new TaskList({})})},window.onload=STM.init();